{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-transparent border-bottom border-secondary py-3 d-flex justify-content-between align-items-center">
                <h4 class="mb-0 fw-bold" style="color: var(--primary-color);">Edit Movie</h4>
                
                <button type="button" id="btnAutoFill" class="btn btn-sm btn-outline-info" 
                        data-bs-toggle="modal" data-bs-target="#tmdbModal"
                        onclick="prefillSearch()"
                        {% if movie.is_locked %}disabled{% endif %}>
                    <i class="bi bi-cloud-download me-1"></i>Auto-Fill from Metadata
                </button>
            </div>
            
            <div class="card-body p-4">
                <form method="POST">
                    
                    <input type="hidden" name="update_method" id="updateMethod" value="Manual Edit">

                    <div class="alert alert-secondary d-flex align-items-center justify-content-between py-2 mb-4" 
                         style="background-color: rgba(0,0,0,0.2); border-color: var(--border-color); color: var(--text-color);">
                        <div>
                            <div class="fw-bold"><i class="bi bi-shield-lock-fill text-warning me-2"></i>Lock Metadata</div>
                            <div class="small text-muted">Prevents Auto-Fill from overwriting this movie.</div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_locked" id="inputLocked" 
                                   style="width: 3em; height: 1.5em;"
                                   {% if movie.is_locked %}checked{% endif %}
                                   onchange="toggleLock()">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label text-muted small fw-bold">Title</label>
                            <input type="text" class="form-control" name="title" value="{{ movie.title }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Year</label>
                            <input type="number" class="form-control" name="year" value="{{ movie.year }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold">Genre</label>
                            <input type="text" class="form-control" name="genre" value="{{ movie.genre }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold">Director</label>
                            <input type="text" class="form-control" name="director" value="{{ movie.director }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label text-muted small fw-bold">Cast</label>
                            <input type="text" class="form-control" name="cast" value="{{ movie.cast }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Runtime (mins)</label>
                            <input type="number" class="form-control" name="runtime" value="{{ movie.runtime }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-9">
                            <label class="form-label text-muted small fw-bold">Poster URL</label>
                            <input type="url" class="form-control" name="poster" value="{{ movie.poster }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted small fw-bold">Rating</label>
                            <input type="number" step="0.1" class="form-control" name="rating" value="{{ movie.rating }}">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold">Physical Format</label>
                            <select name="media_format" class="form-select" style="background-color: var(--card-bg); color: var(--text-color); border-color: var(--border-color);">
                                <option value="" {% if not movie.media_format %}selected{% endif %}>-- Unset --</option>
                                <option value="Blu-ray" {% if movie.media_format == 'Blu-ray' %}selected{% endif %}>Blu-ray</option>
                                <option value="4K Blu-ray" {% if movie.media_format == '4K Blu-ray' %}selected{% endif %}>4K Blu-ray</option>
                                <option value="DVD" {% if movie.media_format == 'DVD' %}selected{% endif %}>DVD</option>
                                <option value="VHS" {% if movie.media_format == 'VHS' %}selected{% endif %}>VHS</option>
                                <option value="Digital" {% if movie.media_format == 'Digital' %}selected{% endif %}>Digital Only</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check p-2 ps-5 rounded w-100 border border-secondary" style="background-color: rgba(0,0,0,0.2);">
                                <input class="form-check-input custom-check" type="checkbox" name="is_ripped" id="checkPlex" 
                                       {% if movie.is_ripped == 1 %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="checkPlex">
                                    <i class="bi bi-server text-warning me-2"></i>Available on Plex?
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Physical Location / Placement</label>
                        <input type="text" class="form-control" name="placement" 
                               placeholder="e.g. Shelf A, Box 2, Office..." 
                               value="{{ movie.placement or '' }}">
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold">Plot Summary</label>
                        <textarea class="form-control" name="plot" rows="4">{{ movie.plot }}</textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-3 pt-3 border-top border-secondary">
                        <a href="/movie/{{ movie.id }}" class="btn btn-outline-secondary fw-bold px-4">Cancel</a>
                        <button type="submit" class="btn btn-primary fw-bold px-4">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="tmdbModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Search Metadata</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="tmdbSearchQuery" class="form-control bg-dark text-white border-secondary">
                    <button class="btn btn-primary" onclick="searchTMDB()">Search</button>
                </div>
                <div id="tmdbResults" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleLock() {
    const isLocked = document.getElementById('inputLocked').checked;
    document.getElementById('btnAutoFill').disabled = isLocked;
}

function prefillSearch() {
    const currentTitle = document.querySelector('input[name="title"]').value;
    document.getElementById('tmdbSearchQuery').value = currentTitle;
    if(currentTitle && currentTitle.length > 2) searchTMDB();
}

async function searchTMDB() {
    const query = document.getElementById('tmdbSearchQuery').value;
    const list = document.getElementById('tmdbResults');
    list.innerHTML = '<div class="text-center p-3 text-white"><div class="spinner-border" role="status"></div></div>';
    
    const res = await fetch(`/api/search_media?title=${encodeURIComponent(query)}`);
    const data = await res.json();
    list.innerHTML = '';
    
    if(!data.results || data.results.length === 0) {
        list.innerHTML = `<div class="alert alert-warning">No results found.</div>`;
        return;
    }
    
    data.results.forEach(movie => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary d-flex align-items-center gap-3';
        const badgeColor = movie.source === 'TMDB' ? 'bg-primary' : 'bg-warning text-dark';
        item.innerHTML = `
            <img src="${movie.poster || 'https://via.placeholder.com/40x60'}" style="width: 40px; height: 60px; object-fit: cover;">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge ${badgeColor} small">${movie.source}</span>
                    <span class="fw-bold">${movie.title}</span>
                </div>
                <small class="text-muted">${movie.year}</small>
            </div>
        `;
        item.onclick = () => fillForm(movie.id, movie.source);
        list.appendChild(item);
    });
}

async function fillForm(mediaId, source) {
    if(document.getElementById('inputLocked').checked) {
        alert("This movie is locked."); return;
    }

    // UPDATE HIDDEN FIELD
    document.getElementById('updateMethod').value = `Auto-Fill (${source})`;

    const res = await fetch(`/api/get_media_details?id=${mediaId}&source=${source}`);
    const m = await res.json();
    
    document.querySelector('[name="title"]').value = m.title || '';
    document.querySelector('[name="year"]').value = m.year || '';
    document.querySelector('[name="genre"]').value = m.genre || '';
    document.querySelector('[name="director"]').value = m.director || '';
    document.querySelector('[name="cast"]').value = m.cast || '';
    document.querySelector('[name="runtime"]').value = m.runtime || '';
    document.querySelector('[name="plot"]').value = m.plot || '';
    document.querySelector('[name="poster"]').value = m.poster || '';
    document.querySelector('[name="rating"]').value = m.rating || '';
    
    bootstrap.Modal.getInstance(document.getElementById('tmdbModal')).hide();
}
</script>
{% endblock %}
