{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-transparent border-bottom border-secondary py-3 d-flex justify-content-between align-items-center">
                <h4 class="mb-0 fw-bold" style="color: var(--primary-color);">Add New Media</h4>
                
                <button type="button" class="btn btn-sm btn-outline-info" 
                        data-bs-toggle="modal" data-bs-target="#tmdbModal"
                        onclick="prefillSearch()">
                    <i class="bi bi-cloud-download me-1"></i>Auto-Fill from Metadata
                </button>
            </div>
            
            <div class="card-body p-4">
                <form method="POST" action="/add">
                    
                    <input type="hidden" name="update_method" id="updateMethod" value="Manual Entry">

                    <div class="alert alert-secondary d-flex align-items-center justify-content-between py-2 mb-4" 
                         style="background-color: rgba(0,0,0,0.2); border-color: var(--border-color); color: var(--text-color);">
                        <div>
                            <div class="fw-bold"><i class="bi bi-shield-lock-fill text-warning me-2"></i>Lock Metadata</div>
                            <div class="small text-muted">Prevent future auto-updates.</div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_locked" id="inputLocked" 
                                   style="width: 3em; height: 1.5em;">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label text-muted small fw-bold">Title</label>
                            <input type="text" class="form-control" name="title" id="inputTitle" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Year</label>
                            <input type="number" class="form-control" name="year" id="inputYear">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold">Genre</label>
                            <input type="text" class="form-control" name="genre" id="inputGenre">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold">Director</label>
                            <input type="text" class="form-control" name="director" id="inputDirector">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label text-muted small fw-bold">Cast</label>
                            <input type="text" class="form-control" name="cast" id="inputCast">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Runtime (mins)</label>
                            <input type="number" class="form-control" name="runtime" id="inputRuntime">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-9">
                            <label class="form-label text-muted small fw-bold">Poster URL</label>
                            <input type="url" class="form-control" name="poster" id="inputPoster">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted small fw-bold">Rating</label>
                            <input type="number" step="0.1" class="form-control" name="rating" id="inputRating">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold">Physical Format</label>
                            <select name="media_format" class="form-select" style="background-color: var(--card-bg); color: var(--text-color); border-color: var(--border-color);">
                                <option value="" selected>-- Select Format --</option>
                                <option value="Blu-ray">Blu-ray</option>
                                <option value="4K Blu-ray">4K Blu-ray</option>
                                <option value="DVD">DVD</option>
                                <option value="VHS">VHS</option>
                                <option value="Digital">Digital Only</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check p-2 ps-5 rounded w-100 border border-secondary" style="background-color: rgba(0,0,0,0.2);">
                                <input class="form-check-input custom-check" type="checkbox" name="is_ripped" id="checkPlex">
                                <label class="form-check-label fw-bold" for="checkPlex">
                                    <i class="bi bi-server text-warning me-2"></i>Available on Plex?
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Physical Location / Placement</label>
                        <input type="text" class="form-control" name="placement" 
                               placeholder="e.g. Shelf A, Box 2, Office...">
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold">Plot Summary</label>
                        <textarea class="form-control" name="plot" id="inputPlot" rows="3"></textarea>
                    </div>

                    <div class="mb-4 p-3 rounded" style="background-color: rgba(0,0,0,0.2); border: 1px dashed var(--border-color);">
                        <label class="form-label text-muted small fw-bold mb-2">Wishlist Priority</label>
                        <select name="priority" class="form-select border-secondary" style="background-color: var(--card-bg); max-width: 200px;">
                            <option value="High">High Priority</option>
                            <option value="Medium" selected>Medium Priority</option>
                            <option value="Low">Low Priority</option>
                        </select>
                        <div class="form-text small text-muted">Ignored if saving to main collection.</div>
                    </div>

                    <div class="d-flex justify-content-end gap-3 pt-3 border-top border-secondary">
                        <a href="/" class="btn btn-outline-secondary fw-bold px-4">Cancel</a>
                        <button type="submit" name="save_target" value="wishlist" class="btn btn-outline-danger fw-bold px-4">
                            <i class="bi bi-heart-fill me-2"></i>Add to Wishlist
                        </button>
                        <button type="submit" name="save_target" value="collection" class="btn btn-warning fw-bold px-4">
                            <i class="bi bi-hdd-fill me-2"></i>Save to Collection
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="tmdbModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Search Metadata (TMDB / OMDB)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="tmdbSearchQuery" class="form-control bg-dark text-white border-secondary" placeholder="Enter movie title...">
                    <button class="btn btn-primary" onclick="searchTMDB()">Search</button>
                </div>
                <div id="tmdbResults" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<script>
// NEW: Grabs the title and auto-searches
function prefillSearch() {
    const currentTitle = document.getElementById('inputTitle').value;
    const searchInput = document.getElementById('tmdbSearchQuery');
    searchInput.value = currentTitle;
    
    // Only search if there is actual text
    if(currentTitle && currentTitle.length > 2) {
        searchTMDB();
    }
}

async function searchTMDB() {
    const query = document.getElementById('tmdbSearchQuery').value;
    const list = document.getElementById('tmdbResults');
    list.innerHTML = '<div class="text-center p-3 text-white"><div class="spinner-border" role="status"></div></div>';

    const res = await fetch(`/api/search_media?title=${encodeURIComponent(query)}`);
    const data = await res.json();
    list.innerHTML = '';
    
    if(!data.results || data.results.length === 0) {
        list.innerHTML = `<div class="alert alert-warning">No results found in configured APIs.</div>`;
        return;
    }

    data.results.forEach(movie => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary d-flex align-items-center gap-3';
        
        // Color badge based on source
        const badgeColor = movie.source === 'TMDB' ? 'bg-primary' : 'bg-warning text-dark';
        
        item.innerHTML = `
            <img src="${movie.poster || 'https://via.placeholder.com/40x60'}" style="width: 40px; height: 60px; object-fit: cover;">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge ${badgeColor} small">${movie.source}</span>
                    <span class="fw-bold">${movie.title}</span>
                </div>
                <small class="text-muted">${movie.year}</small>
            </div>
        `;
        item.onclick = () => fillForm(movie.id, movie.source);
        list.appendChild(item);
    });
}

async function fillForm(mediaId, source) {
    if(document.getElementById('inputLocked') && document.getElementById('inputLocked').checked) {
        alert("This movie is locked. Unlock it to auto-fill data.");
        return;
    }

    // UPDATE HIDDEN FIELD FOR AUDIT LOG
    document.getElementById('updateMethod').value = `Auto-Fill (${source})`;

    const res = await fetch(`/api/get_media_details?id=${mediaId}&source=${source}`);
    const m = await res.json();
    
    document.querySelector('[name="title"]').value = m.title || '';
    document.querySelector('[name="year"]').value = m.year || '';
    document.querySelector('[name="genre"]').value = m.genre || '';
    document.querySelector('[name="director"]').value = m.director || '';
    document.querySelector('[name="cast"]').value = m.cast || '';
    document.querySelector('[name="runtime"]').value = m.runtime || '';
    document.querySelector('[name="plot"]').value = m.plot || '';
    document.querySelector('[name="poster"]').value = m.poster || '';
    document.querySelector('[name="rating"]').value = m.rating || '';
    
    bootstrap.Modal.getInstance(document.getElementById('tmdbModal')).hide();
}
</script>
{% endblock %}
